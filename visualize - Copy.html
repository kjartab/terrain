<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <title>Terrain Mapping</title>

    <link href="css/leaflet.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/viewer.css" rel="stylesheet">	
</head>
<body>	
	<script src="/assets/lib/jquery/jquery-2.1.1.min.js"></script>
    <script src="/assets/lib/bootstrap/js/bootstrap.min.js"></script>
	<script src="/assets/lib/three/three.js"></script>
    <script src="/assets/lib/leaflet/leaflet.js"></script>
    <script src="/assets/lib/three/extensions/TrackballControls.js"></script>
    <script src="/assets/lib/three/extensions/water-material.js"></script>
	
    <script src="/assets/common/threeExtras/world.js"></script>	
    <script src="/assets/common/threeExtras/simpleTrack.js"></script>
	
	
    <script src="/assets/common/loaders/simpleXYZload.js"></script>
    <script src="/assets/common/loaders/WKBloader.js"></script>
    <script src="js/FileSaver.js"></script>
	
	
  
  <!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" id="navbar">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Terrain</a>
        </div>
      </div>	
    </div>
	
		<div id="content">
			<div id="webgl"></div>
		</div>
		<div class="spinner"></div>

      
<script>
	
	$(window).resize(function () {
		var h = $(window).height(), offsetTop = $('#navbar').height();
		$('#content').css('height', h-offsetTop+3);
		$('#webgl').css('height', h-offsetTop+3);
		$('body').css('height', h-offsetTop+3);
		
	}).resize();
	
	
	
	
	function getUrlVars() {
		var vars = {};
		console.log(window.location.href);
		var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
			vars[key] = value;
		});
		return vars;
	}
	var outline = getUrlVars()["outline"];
	var table = getUrlVars()["table"];
	
    var width  = $('#content').width(),
        height = $('#content').height();
	
	
	var worldRef;
	
	var terrainGeometry, plane, material;
	var camera;
	var scene;
	var controls;
	var directionalLight;
	
		function parseSTL(geometry){

		var vector = new THREE.Vector3();
		var normalMatrixWorld = new THREE.Matrix3();

			var output = '';

			output += 'solid exported\n';

			scene.traverse( function ( object ) {

				if ( object instanceof THREE.Mesh ) {

					var geometry = object.geometry;
					var matrixWorld = object.matrixWorld;

					if ( geometry instanceof THREE.Geometry ) {

						var vertices = geometry.vertices;
						var faces = geometry.faces;

						normalMatrixWorld.getNormalMatrix( matrixWorld );

						for ( var i = 0, l = faces.length; i < l; i ++ ) {

							var face = faces[ i ];

							vector.copy( face.normal ).applyMatrix3( normalMatrixWorld ).normalize();

							output += '\tfacet normal ' + vector.x + ' ' + vector.y + ' ' + vector.z + '\n';
							output += '\t\touter loop\n';

							var indices = [ face.a, face.b, face.c ];

							for ( var j = 0; j < 3; j ++ ) {

								vector.copy( vertices[ indices[ j ] ] ).applyMatrix4( matrixWorld );

								output += '\t\t\tvertex ' + vector.x + ' ' + vector.y + ' ' + vector.z + '\n';

							}

							output += '\t\tendloop\n';
							output += '\tendfacet\n';

						}

					}

				}

			} );

			output += 'endsolid exported\n';

			return output;

		};


	
	
	/**
	 * @author mrdoob / http://mrdoob.com/
	 */
	 
	function exporter(geometry) {



		var output = '';

		for ( var i = 0, l = geometry.vertices.length; i < l; i ++ ) {

			var vertex = geometry.vertices[ i ];
			output += 'v ' + vertex.x + ' ' + vertex.y + ' ' + vertex.z + '\n';

		}

		// uvs

		for ( var i = 0, l = geometry.faceVertexUvs[ 0 ].length; i < l; i ++ ) {

			var vertexUvs = geometry.faceVertexUvs[ 0 ][ i ];

			for ( var j = 0; j < vertexUvs.length; j ++ ) {

				var uv = vertexUvs[ j ];
				output += 'vt ' + uv.x + ' ' + uv.y + '\n';

			}

		}

		// normals

		for ( var i = 0, l = geometry.faces.length; i < l; i ++ ) {

			var normals = geometry.faces[ i ].vertexNormals;

			for ( var j = 0; j < normals.length; j ++ ) {

				var normal = normals[ j ];
				output += 'vn ' + normal.x + ' ' + normal.y + ' ' + normal.z + '\n';

			}

		}

		// faces

		for ( var i = 0, j = 1, l = geometry.faces.length; i < l; i ++, j += 3 ) {

			var face = geometry.faces[ i ];

			output += 'f ';
			output += ( face.a + 1 ) + '/' + ( j ) + '/' + ( j ) + ' ';
			output += ( face.b + 1 ) + '/' + ( j + 1 ) + '/' + ( j + 1 ) + ' ';
			output += ( face.c + 1 ) + '/' + ( j + 2 ) + '/' + ( j + 2 ) + '\n';

		}

		return output;
	}

	function init() {
		camera = new THREE.PerspectiveCamera(25, width / height, 0.1, 60000);
		camera.position.set(0, -420, 320);	
		controls = new THREE.TrackballControls(camera); 
		
		renderer = new THREE.WebGLRenderer( { antialias: true } );
		renderer.setSize(width, height);
		renderer.setClearColor( 0xffffff, 1);
		
		scene = new THREE.Scene();
		scene.add(new THREE.AmbientLight(0x222222));
		
		directionalLight = new THREE.DirectionalLight(0xffffff, 1);
		directionalLight.position.set(-600, 300, 600);
		scene.add(directionalLight);
		
		document.getElementById('webgl').appendChild(renderer.domElement);
		render();
	}
	function export_text( text ) {
		var content = "data:application/plain;charset=utf-8," + escape( text );
		window.open( content, '_blank' );
	}

	worldReference.init(1/100,32632);
	console.log(worldReference);
	var xyzRequest = new XMLHttpRequest();
	
	xyzRequest.open("GET", '/datapi/rasters/dtm/?format=xyz&outline='+outline+'&table='+table, true);
	xyzRequest.onreadystatechange = function() {
		if(xyzRequest.readyState==4){
			
			var material = new THREE.MeshLambertMaterial({  color: 0xefefef, shading: THREE.SmoothShading})
			
			terrainGeometry = xyzLoader.loadData(xyzRequest.responseText,worldReference);
			
			var plane = new THREE.Mesh(terrainGeometry, material);
			window.scene.add(plane);
			
			
			$('.spinner').fadeOut(300, function() {
				$('.spinner').hide();
			});
			
			var blob = new Blob([parseSTL(terrainGeometry)], {type: "text/plain;charset=utf-8"});
			saveAs(blob, "hello world.obj");

		
			
		}
		
	}
	
	
	xyzRequest.send();
	
	function render() {
		controls.update();  
		requestAnimationFrame(render);
		renderer.render(scene, camera);
	}

	init();

	
	
	
</script>
</body>
</html>