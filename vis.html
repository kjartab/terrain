<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <title>Terrain Mapping</title>

    <link href="css/leaflet.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/viewer.css" rel="stylesheet">	
</head>
<body>
  
    <script src="/assets/lib/jquery/jquery-2.1.1.min.js"></script>
    <script src="/assets/lib/bootstrap/js/bootstrap.min.js"></script>
	<script src="/assets/lib/three/three.js"></script>
    <script src="/assets/lib/leaflet/leaflet.js"></script>
    <script src="/assets/lib/three/extensions/trackballControls.js"></script>
    <script src="/assets/lib/three/extensions/water-material.js"></script>
	
    <script src="/assets/common/threeExtras/world.js"></script>	
    <script src="/assets/common/threeExtras/simpleTrack.js"></script>
    <script src="/assets/common/loaders/simpleXYZload.js"></script>
    <script src="/assets/common/loaders/WKBloader.js"></script>
	
	
    <div class="navbar navbar-default navbar-fixed-top" id="navbar">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Terrain</a>
        </div>
      </div>
    </div>
	
	<div id="content">
		<div id="webgl"></div>
	</div>

      
<script>
	

	$(window).resize(function () {
		var h = $(window).height(), offsetTop = $('#navbar').height();
		$('#content').css('height', h-offsetTop+3);
		$('#webgl').css('height', h-offsetTop+3);
		$('body').css('height', h-offsetTop+3);
		
	}).resize();
	
	function getUrlVars() {
		var vars = {};
		var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
			vars[key] = value;
		});
		return vars;
	}
	
	var outline = getUrlVars()["outline"];
	var table = getUrlVars()["table"];
	
    var width  = $('#content').width(),
        height = $('#content').height();
	
	var water;
	var aMeshMirror;
	var waterNormals;
	
	var geometry, plane, material;
	var camera;
	var scene;
	var controls;
	var directionalLight;
	
	function init() {
		camera = new THREE.PerspectiveCamera(25, width / height, 0.1, 60000);
		camera.position.set(0, -30, 30);	

		controls = new THREE.TrackballControls(camera); 
		renderer = new THREE.WebGLRenderer( { antialias: true } );
		renderer.setSize(width, height);
		renderer.setClearColor( 0xffffff, 1);

		scene = new THREE.Scene();
		scene.add(new THREE.AmbientLight(0x222222));
		
		directionalLight = new THREE.DirectionalLight(0xffffff, 1);
		directionalLight.position.set(-600, 300, 600);
		scene.add(directionalLight);
		
		material = new THREE.MeshBasicMaterial();
		
		document.getElementById('webgl').appendChild(renderer.domElement);
		render();
	}
	init();

	var rows = 0;
	var cols = 0;
	var count = 0;
	
	var delim = "\n";
	var postdelim = '\\\\012';
	var worldRef;
	var minX, minZ, minY;
	var dem=new XMLHttpRequest();
	dem.open("GET", '../data/rasters/rasterdata/?format=xyz&outline='+outline+'&table='+table, true);
	//dem.open("GET", '../data/rasters/rasterdataRaw/?format=xyz&table=sunnfjordterrain', true);
	//dem.open('GET','result.xyz');
	dem.onreadystatechange = function() {
		if(dem.readyState==4){
			var geometry = new THREE.Geometry();
			console.log(worldReference);
			console.log(xyzLoader);
			xyzLoader.loadData(dem.responseText,worldReference);
			
			//loadTrack();
		}
		
			
	}
	dem.send();
	
	function addWater(wgeometry) {
		
		// Load textures		
		waterNormals = new THREE.ImageUtils.loadTexture('assets/img/waternormals.jpg');
		waterNormals.wrapS = waterNormals.wrapT = THREE.RepeatWrapping; 
		
		// Create the water effect
		water = new THREE.Water(renderer, window.camera, window.scene, {
			textureWidth: 512, 
			textureHeight: 512,
			waterNormals: waterNormals,
			alpha: 	0.9,
			sunDirection: window.directionalLight.position.normalize(),
			sunColor: 0xffffff,
			waterColor: 0x001e0f,
			distortionScale: 50.0
		});
		
		aMeshMirror = new THREE.Mesh(
			wgeometry, 
			water.material
		);
		aMeshMirror.add(water);
		aMeshMirror.rotation.x = - Math.PI * 0.5;
		scene.add(aMeshMirror);
	}
	
	
	
	
	
  function render() {
    controls.update();  
	if (water) {
		water.material.uniforms.time.value += 1.0 / 60.0;
		water.render();
	}
    requestAnimationFrame(render);
    renderer.render(scene, camera);
  }
	
	
	
	
	
var nSide;
var npMaterial
	var posdata;
	
	
	/*
	function loadTrack() {
		$.getJSON('../data/langeland/segments32632/', function (data) {
			posdata = JSON.parse(data);
		
		nSide = new THREE.Geometry();
		npMaterial = new THREE.ParticleBasicMaterial({
		  color: 0x0000FF,
		  size: 0.2
		});
			var k;
				var kk =  posdata.coordinates;
			for (var i=0; i<kk.length; i++) {	
				for (var j=0; j<kk[i].length; j++) {
					k = kk[i][j];
					k[0] = (k[0]-worldRef.getXoffset())/(100);
					k[1] = (k[1]-worldRef.getYoffset())/(100);
					k[2] = (k[2]-worldRef.getZoffset()+20)/100;
				
				nSide.vertices.push(new THREE.Vector3(k[0],k[1],k[2]));
				}
				
				
				
	

			}
			
			nSide.vertices.push(new THREE.Vector3(0,0,0));
			
			
				
		var nparticleSystem = new THREE.PointCloud(
			nSide,
			npMaterial);
		window.scene.add(nparticleSystem);
		});
	}
*/
	
	var oReq;
	
	function loadTrack() {
		console.log(worldRef);
		console.log('start loading track');
		oReq = new XMLHttpRequest();
	
		//oReq.open("GET", 'http://localhost/langeland/data/segments/', true);
		oReq.open("GET", '../data/langeland/spatiotemporalewkb', true);
		//oReq.open("GET", '../data/tracking/wkbgallen/', true);
		oReq.responseType = "arraybuffer";	

		oReq.onload = function (oEvent) {
			arrayBuffer = oReq.response;
			if (arrayBuffer) {
				loadLine(arrayBuffer,geometry,worldReference,100);
			}	  
	  
		}
	
		oReq.send();
	}
	
	
</script>
</body>
</html>